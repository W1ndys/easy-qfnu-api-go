# qfnu-api-go 开发规范

## 1. 工程目录结构 (Project Layout)

本项目遵循 Go 社区标准工程结构 (Standard Go Project Layout)，强调职责分离与模块化。

```text
qfnu-api-go/
├── api/                    # 【接口层】Handler 处理函数，负责参数解析与响应封装
│   └── v1/                 # 版本控制，如 grade_handler.go
├── common/                 # 【公共层】通用工具
│   └── response/           # 统一响应封装 (response.go)
├── middleware/             # 【中间件】全局拦截器 (如 CORS, Auth, Logger)
├── model/                  # 【模型层】数据结构定义 (Struct)，对应数据库或下游返回
│   └── grade.go            # 成绩结构体
├── service/                # 【逻辑层】核心业务逻辑、爬虫、数据清洗
│   └── grade_service.go    # 成绩抓取与解析逻辑
├── go.mod                  # 依赖管理文件
└── main.go                 # 程序入口，负责路由注册与组件装配

```

---

## 2. 接口交互协议 (API Protocol)

* **传输协议**: HTTP/1.1
* **请求格式**:
* GET 请求参数使用 Query String
* POST 请求参数推荐使用 `application/json` 或 `application/x-www-form-urlencoded`


* **响应格式**: 统一使用 `application/json; charset=utf-8`
* **字符编码**: 内部统一处理为 UTF-8，对上游 GBK 编码进行透明转换。

---

## 3. 请求规范 (Request Standards)

### 3.1 鉴权 (Authentication)

本系统为无状态代理，不存储用户敏感信息。教务系统的 Cookie (Session ID) 必须通过 **HTTP Header** 传递，禁止在 URL 中明文传输。

| 参数名      | 位置   | 必填 | 说明                         | 示例                                 |
| ----------- | ------ | ---- | ---------------------------- | ------------------------------------ |
| **X-Token** | Header | 是   | 教务系统的完整 Cookie 字符串 | `JSESSIONID=abc123456; SERVERID=...` |

> **安全提示**: 使用 Header 传递 Token 可避免 Token 被记录在服务器日志、代理服务器日志或浏览器历史记录中。

### 3.2 参数传递

* **资源定位**: 使用 Path 参数，如 `/api/users/:id`
* **筛选与分页**: 使用 Query 参数，如 `/api/grades?term=2025-2026-1`
* **表单提交**: 使用 Body 参数。

---

## 4. 响应规范 (Response Standards)

所有 API 必须返回统一的 JSON 结构（信封模式），禁止直接返回数组或裸数据。

### 4.1 统一结构定义

```go
type Response struct {
    Code int         `json:"code"` // 业务状态码：0-成功，非0-失败
    Msg  string      `json:"msg"`  // 提示信息：用于前端弹窗
    Data interface{} `json:"data"` // 业务数据：可以是 Object, Array 或 null
}

```

### 4.2 成功响应示例 (HTTP 200)

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "list": [
      {
        "course_name": "高等数学",
        "score": "95"
      }
    ],
    "count": 1
  }
}

```

### 4.3 失败响应示例 (HTTP 200)

注意：业务逻辑错误（如 Cookie 失效）通常返回 HTTP 200，通过 `code` 区分。

```json
{
  "code": 401,
  "msg": "Cookie 已失效，请重新登录",
  "data": null
}

```

---

## 5. 开发流程规范 (Development Workflow)

新增一个功能（例如：查询课表）的步骤：

1. **Model 层**:
* 在 `model/` 下新建 `schedule.go`。
* 定义 `Schedule` 结构体，字段首字母**必须大写**，并添加 `json` tag（推荐蛇形命名 `json:"course_name"`）。


2. **Service 层**:
* 在 `service/` 下新建 `schedule_service.go`。
* 编写 `FetchSchedule(cookie string)` 函数。
* 负责 Resty 请求、HTML 解析 (Goquery) 和数据清洗。
* **错误处理**: 遇到错误直接 `return nil, err`，不要在 Service 层吞掉错误。


3. **API 层**:
* 在 `api/v1/` 下新建 `schedule_handler.go`。
* 编写 `GetSchedule(c *gin.Context)`。
* 解析 Header 中的 `X-Token`。
* 调用 Service，处理 error，使用 `response.Success` 或 `response.Fail` 返回结果。


4. **Main 入口**:
* 在 `main.go` 中注册路由：`r.GET("/api/schedule", v1.GetSchedule)`。



---

## 6. 错误代码表 (Error Codes)

| Code    | 说明                  | 处理建议                            |
| ------- | --------------------- | ----------------------------------- |
| **0**   | **成功**              | 正常展示 Data                       |
| **1**   | **通用错误**          | 弹窗提示 Msg 内容                   |
| **401** | **未授权/Cookie失效** | 跳转至登录页引导用户重新输入 Cookie |
| **502** | **上游错误**          | 教务系统无响应或连接超时            |
| **500** | **解析错误**          | HTML 结构变更，需维护解析逻辑       |

 