# qfnu-api-go å¼€å‘è§„èŒƒ

## 1. å·¥ç¨‹ç›®å½•ç»“æ„ (Project Layout)

æœ¬é¡¹ç›®éµå¾ª Go ç¤¾åŒºæ ‡å‡†å·¥ç¨‹ç»“æ„ (Standard Go Project Layout)ï¼Œå¼ºè°ƒèŒè´£åˆ†ç¦»ä¸æ¨¡å—åŒ–ã€‚

```text
qfnu-api-go/
â”œâ”€â”€ api/                    # ã€æ¥å£å±‚ã€‘Handler å¤„ç†å‡½æ•°ï¼Œè´Ÿè´£å‚æ•°è§£æä¸å“åº”å°è£…
â”‚   â””â”€â”€ v1/                 # ç‰ˆæœ¬æ§åˆ¶ï¼Œå¦‚ grade_handler.go
â”œâ”€â”€ common/                 # ã€å…¬å…±å±‚ã€‘é€šç”¨å·¥å…·
â”‚   â””â”€â”€ response/           # ç»Ÿä¸€å“åº”å°è£… (response.go)
â”œâ”€â”€ middleware/             # ã€ä¸­é—´ä»¶ã€‘å…¨å±€æ‹¦æˆªå™¨ (å¦‚ CORS, Auth, Logger)
â”œâ”€â”€ model/                  # ã€æ¨¡å‹å±‚ã€‘æ•°æ®ç»“æ„å®šä¹‰ (Struct)ï¼Œå¯¹åº”æ•°æ®åº“æˆ–ä¸‹æ¸¸è¿”å›
â”‚   â””â”€â”€ grade.go            # æˆç»©ç»“æ„ä½“
â”œâ”€â”€ service/                # ã€é€»è¾‘å±‚ã€‘æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€çˆ¬è™«ã€æ•°æ®æ¸…æ´—
â”‚   â””â”€â”€ grade_service.go    # æˆç»©æŠ“å–ä¸è§£æé€»è¾‘
â”œâ”€â”€ web/                    # ã€å‰ç«¯å±‚ã€‘Go æ¨¡æ¿ + é™æ€èµ„æº
â”‚   â”œâ”€â”€ templates/          # Go HTML æ¨¡æ¿æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ layouts/        # å¸ƒå±€æ¨¡æ¿
â”‚   â”‚   â”‚   â””â”€â”€ base.html   # åŸºç¡€å¸ƒå±€ï¼ˆå¼•å…¥CDNã€å…¬å…±å¤´å°¾ï¼‰
â”‚   â”‚   â”œâ”€â”€ index.html      # é¦–é¡µï¼ˆåŠŸèƒ½å¯¼èˆªé¡µï¼‰
â”‚   â”‚   â””â”€â”€ grade.html      # æˆç»©æŸ¥è¯¢é¡µé¢
â”‚   â””â”€â”€ static/             # é™æ€èµ„æº
â”‚       â”œâ”€â”€ js/             # JavaScript æ–‡ä»¶
â”‚       â”‚   â”œâ”€â”€ api/        # API æ¨¡å—å°è£…
â”‚       â”‚   â”‚   â”œâ”€â”€ index.js    # API ç»Ÿä¸€å¯¼å‡º
â”‚       â”‚   â”‚   â”œâ”€â”€ request.js  # Axios è¯·æ±‚å°è£…
â”‚       â”‚   â”‚   â””â”€â”€ grade.js    # æˆç»©ç›¸å…³ API
â”‚       â”‚   â”œâ”€â”€ utils/      # å·¥å…·å‡½æ•°
â”‚       â”‚   â”‚   â””â”€â”€ cookie.js   # Cookie å¤„ç†å·¥å…·
â”‚       â”‚   â””â”€â”€ pages/      # é¡µé¢é€»è¾‘
â”‚       â”‚       â””â”€â”€ grade.js    # æˆç»©é¡µé¢é€»è¾‘
â”‚       â””â”€â”€ css/            # è‡ªå®šä¹‰æ ·å¼ï¼ˆå¦‚æœ‰ï¼‰
â”‚           â””â”€â”€ custom.css
â”œâ”€â”€ go.mod                  # ä¾èµ–ç®¡ç†æ–‡ä»¶
â””â”€â”€ main.go                 # ç¨‹åºå…¥å£ï¼Œè´Ÿè´£è·¯ç”±æ³¨å†Œä¸ç»„ä»¶è£…é…
```

---

## 2. æ¥å£äº¤äº’åè®® (API Protocol)

* **ä¼ è¾“åè®®**: HTTP/1.1
* **è¯·æ±‚æ ¼å¼**:
* GET è¯·æ±‚å‚æ•°ä½¿ç”¨ Query String
* POST è¯·æ±‚å‚æ•°æ¨èä½¿ç”¨ `application/json` æˆ– `application/x-www-form-urlencoded`


* **å“åº”æ ¼å¼**: ç»Ÿä¸€ä½¿ç”¨ `application/json; charset=utf-8`
* **å­—ç¬¦ç¼–ç **: å†…éƒ¨ç»Ÿä¸€å¤„ç†ä¸º UTF-8ï¼Œå¯¹ä¸Šæ¸¸ GBK ç¼–ç è¿›è¡Œé€æ˜è½¬æ¢ã€‚

---

## 3. è¯·æ±‚è§„èŒƒ (Request Standards)

### 3.1 é‰´æƒ (Authentication)

æœ¬ç³»ç»Ÿä¸ºæ— çŠ¶æ€ä»£ç†ï¼Œä¸å­˜å‚¨ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ã€‚æ•™åŠ¡ç³»ç»Ÿçš„ Cookie (Session ID) å¿…é¡»é€šè¿‡ **HTTP Header** ä¼ é€’ï¼Œç¦æ­¢åœ¨ URL ä¸­æ˜æ–‡ä¼ è¾“ã€‚

| å‚æ•°å      | ä½ç½®   | å¿…å¡« | è¯´æ˜                         | ç¤ºä¾‹                                 |
| ----------- | ------ | ---- | ---------------------------- | ------------------------------------ |
| **X-Token** | Header | æ˜¯   | æ•™åŠ¡ç³»ç»Ÿçš„å®Œæ•´ Cookie å­—ç¬¦ä¸² | `JSESSIONID=abc123456; SERVERID=...` |

> **å®‰å…¨æç¤º**: ä½¿ç”¨ Header ä¼ é€’ Token å¯é¿å… Token è¢«è®°å½•åœ¨æœåŠ¡å™¨æ—¥å¿—ã€ä»£ç†æœåŠ¡å™¨æ—¥å¿—æˆ–æµè§ˆå™¨å†å²è®°å½•ä¸­ã€‚

### 3.2 å‚æ•°ä¼ é€’

* **èµ„æºå®šä½**: ä½¿ç”¨ Path å‚æ•°ï¼Œå¦‚ `/api/users/:id`
* **ç­›é€‰ä¸åˆ†é¡µ**: ä½¿ç”¨ Query å‚æ•°ï¼Œå¦‚ `/api/grades?term=2025-2026-1`
* **è¡¨å•æäº¤**: ä½¿ç”¨ Body å‚æ•°ã€‚

---

## 4. å“åº”è§„èŒƒ (Response Standards)

æ‰€æœ‰ API å¿…é¡»è¿”å›ç»Ÿä¸€çš„ JSON ç»“æ„ï¼ˆä¿¡å°æ¨¡å¼ï¼‰ï¼Œç¦æ­¢ç›´æ¥è¿”å›æ•°ç»„æˆ–è£¸æ•°æ®ã€‚

### 4.1 ç»Ÿä¸€ç»“æ„å®šä¹‰

```go
type Response struct {
    Code int         `json:"code"` // ä¸šåŠ¡çŠ¶æ€ç ï¼š0-æˆåŠŸï¼Œé0-å¤±è´¥
    Msg  string      `json:"msg"`  // æç¤ºä¿¡æ¯ï¼šç”¨äºå‰ç«¯å¼¹çª—
    Data interface{} `json:"data"` // ä¸šåŠ¡æ•°æ®ï¼šå¯ä»¥æ˜¯ Object, Array æˆ– null
}

```

### 4.2 æˆåŠŸå“åº”ç¤ºä¾‹ (HTTP 200)

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "list": [
      {
        "course_name": "é«˜ç­‰æ•°å­¦",
        "score": "95"
      }
    ],
    "count": 1
  }
}

```

### 4.3 å¤±è´¥å“åº”ç¤ºä¾‹ (HTTP 200)

æ³¨æ„ï¼šä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆå¦‚ Cookie å¤±æ•ˆï¼‰é€šå¸¸è¿”å› HTTP 200ï¼Œé€šè¿‡ `code` åŒºåˆ†ã€‚

```json
{
  "code": 401,
  "msg": "Cookie å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•",
  "data": null
}

```

---

## 5. å¼€å‘æµç¨‹è§„èŒƒ (Development Workflow)

æ–°å¢ä¸€ä¸ªåŠŸèƒ½ï¼ˆä¾‹å¦‚ï¼šæŸ¥è¯¢è¯¾è¡¨ï¼‰çš„æ­¥éª¤ï¼š

1. **Model å±‚**:
* åœ¨ `model/` ä¸‹æ–°å»º `schedule.go`ã€‚
* å®šä¹‰ `Schedule` ç»“æ„ä½“ï¼Œå­—æ®µé¦–å­—æ¯**å¿…é¡»å¤§å†™**ï¼Œå¹¶æ·»åŠ  `json` tagï¼ˆæ¨èè›‡å½¢å‘½å `json:"course_name"`ï¼‰ã€‚


2. **Service å±‚**:
* åœ¨ `service/` ä¸‹æ–°å»º `schedule_service.go`ã€‚
* ç¼–å†™ `FetchSchedule(cookie string)` å‡½æ•°ã€‚
* è´Ÿè´£ Resty è¯·æ±‚ã€HTML è§£æ (Goquery) å’Œæ•°æ®æ¸…æ´—ã€‚
* **é”™è¯¯å¤„ç†**: é‡åˆ°é”™è¯¯ç›´æ¥ `return nil, err`ï¼Œä¸è¦åœ¨ Service å±‚åæ‰é”™è¯¯ã€‚


3. **API å±‚**:
* åœ¨ `api/v1/` ä¸‹æ–°å»º `schedule_handler.go`ã€‚
* ç¼–å†™ `GetSchedule(c *gin.Context)`ã€‚
* è§£æ Header ä¸­çš„ `X-Token`ã€‚
* è°ƒç”¨ Serviceï¼Œå¤„ç† errorï¼Œä½¿ç”¨ `response.Success` æˆ– `response.Fail` è¿”å›ç»“æœã€‚


4. **Main å…¥å£**:
* åœ¨ `main.go` ä¸­æ³¨å†Œè·¯ç”±ï¼š`r.GET("/api/schedule", v1.GetSchedule)`ã€‚



---

## 6. é”™è¯¯ä»£ç è¡¨ (Error Codes)

| Code    | è¯´æ˜                  | å¤„ç†å»ºè®®                            |
| ------- | --------------------- | ----------------------------------- |
| **0**   | **æˆåŠŸ**              | æ­£å¸¸å±•ç¤º Data                       |
| **1**   | **é€šç”¨é”™è¯¯**          | å¼¹çª—æç¤º Msg å†…å®¹                   |
| **401** | **æœªæˆæƒ/Cookieå¤±æ•ˆ** | è·³è½¬è‡³ç™»å½•é¡µå¼•å¯¼ç”¨æˆ·é‡æ–°è¾“å…¥ Cookie |
| **502** | **ä¸Šæ¸¸é”™è¯¯**          | æ•™åŠ¡ç³»ç»Ÿæ— å“åº”æˆ–è¿æ¥è¶…æ—¶            |
| **500** | **è§£æé”™è¯¯**          | HTML ç»“æ„å˜æ›´ï¼Œéœ€ç»´æŠ¤è§£æé€»è¾‘       |

---

## 7. å‰ç«¯å¼€å‘è§„èŒƒ (Frontend Standards)

### 7.1 æŠ€æœ¯æ ˆ

| æŠ€æœ¯         | è¯´æ˜                       | CDN å¼•å…¥æ–¹å¼                                                    |
| ------------ | -------------------------- | --------------------------------------------------------------- |
| TailwindCSS  | CSS æ¡†æ¶                   | `<script src="https://cdn.tailwindcss.com"></script>`          |
| Vant         | ç§»åŠ¨ç«¯ç»„ä»¶åº“               | `<link rel="stylesheet" href="https://unpkg.com/vant@4/lib/index.css">` + `<script src="https://unpkg.com/vant@4/lib/vant.min.js"></script>` |
| Axios        | HTTP è¯·æ±‚åº“                | `<script src="https://unpkg.com/axios/dist/axios.min.js"></script>` |
| Go Template  | æœåŠ¡ç«¯æ¨¡æ¿æ¸²æŸ“             | å†…ç½®                                                            |

### 7.2 é¡µé¢ç»“æ„

æ‰€æœ‰é¡µé¢åŸºäº `layouts/base.html` å¸ƒå±€æ¨¡æ¿ï¼š

```html
<!-- web/templates/layouts/base.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - å·å·çš„å°å·¥å…·åº“</title>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vant æ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/vant@4/lib/index.css">
</head>
<body class="bg-gray-100 min-h-screen">
    {{template "content" .}}

    <!-- Vant -->
    <script src="https://unpkg.com/vant@4/lib/vant.min.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- API æ¨¡å— -->
    <script src="/static/js/api/request.js"></script>
    <script src="/static/js/api/index.js"></script>
    {{block "scripts" .}}{{end}}
</body>
</html>
```

### 7.3 å‰ç«¯ API å°è£…è§„èŒƒ

#### 7.3.1 è¯·æ±‚å°è£… (request.js)

```javascript
// web/static/js/api/request.js
const request = axios.create({
    baseURL: '/api',
    timeout: 30000,
    headers: {
        'Content-Type': 'application/json'
    }
});

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨é™„åŠ  Cookie
request.interceptors.request.use(config => {
    const token = localStorage.getItem('qfnu_cookie') || '';
    if (token) {
        config.headers['X-Token'] = token;
    }
    return config;
});

// å“åº”æ‹¦æˆªå™¨ï¼šç»Ÿä¸€å¤„ç†é”™è¯¯
request.interceptors.response.use(
    response => {
        const res = response.data;
        if (res.code !== 0) {
            vant.showToast({ message: res.msg, type: 'fail' });
            if (res.code === 401) {
                // Cookie å¤±æ•ˆï¼Œæ¸…é™¤å¹¶æç¤º
                localStorage.removeItem('qfnu_cookie');
            }
            return Promise.reject(res);
        }
        return res;
    },
    error => {
        vant.showToast({ message: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', type: 'fail' });
        return Promise.reject(error);
    }
);
```

#### 7.3.2 API æ¨¡å—åŒ– (æŒ‰åŠŸèƒ½æ‹†åˆ†)

```javascript
// web/static/js/api/grade.js
const gradeApi = {
    // è·å–æˆç»©åˆ—è¡¨
    getList(params = {}) {
        return request.get('/v1/grade', { params });
    },
    // è·å–æˆç»©è¯¦æƒ…
    getDetail(id) {
        return request.get(`/v1/grade/${id}`);
    }
};

// web/static/js/api/schedule.js
const scheduleApi = {
    // è·å–è¯¾è¡¨
    getSchedule(params = {}) {
        return request.get('/v1/schedule', { params });
    }
};
```

#### 7.3.3 ç»Ÿä¸€å¯¼å‡º (index.js)

```javascript
// web/static/js/api/index.js
const api = {
    grade: gradeApi,
    schedule: scheduleApi
    // æ–°æ¨¡å—åœ¨æ­¤æ³¨å†Œ
};
```

### 7.4 Cookie è¾“å…¥äº¤äº’è§„èŒƒ

æ¯ä¸ªåŠŸèƒ½é¡µé¢å¿…é¡»åŒ…å« Cookie è¾“å…¥ç»„ä»¶ï¼š

Cookie éšç§ä¿æŠ¤

- æ·»åŠ äºšå…‹åŠ›æ¨¡ç³Šæ•ˆæœ CSS
- å¤±ç„¦æ—¶è‡ªåŠ¨æ¨¡ç³Šï¼ˆblur: 6px + opacity: 0.7ï¼‰
- æ‚¬åœæˆ–èšç„¦æ—¶æ¢å¤æ¸…æ™°

```html
<!-- Cookie è¾“å…¥åŒºåŸŸ -->
<div class="p-4 bg-white rounded-lg shadow mb-4">
    <van-field
        v-model="cookie"
        label="Cookie"
        type="textarea"
        rows="3"
        placeholder="è¯·ç²˜è´´æ•™åŠ¡ç³»ç»Ÿ Cookie"
        @blur="saveCookie"
    />
    <van-button type="primary" block @click="handleSubmit" class="mt-3">
        æŸ¥è¯¢
    </van-button>
</div>
```

```javascript
// Cookie å¤„ç†é€»è¾‘
const cookieUtils = {
    // ä¿å­˜ Cookie åˆ°æœ¬åœ°
    save(cookie) {
        if (cookie && cookie.trim()) {
            localStorage.setItem('qfnu_cookie', cookie.trim());
        }
    },
    // è·å–æœ¬åœ° Cookie
    get() {
        return localStorage.getItem('qfnu_cookie') || '';
    },
    // æ¸…é™¤ Cookie
    clear() {
        localStorage.removeItem('qfnu_cookie');
    }
};
```

---

## 8. å‰ç«¯å¼€å‘æµç¨‹ (Frontend Workflow)

æ–°å¢ä¸€ä¸ªåŠŸèƒ½é¡µé¢ï¼ˆä¾‹å¦‚ï¼šè¯¾è¡¨æŸ¥è¯¢ï¼‰çš„æ­¥éª¤ï¼š

### 8.1 åˆ›å»º API æ¨¡å—

```javascript
// web/static/js/api/schedule.js
const scheduleApi = {
    getSchedule(term) {
        return request.get('/v1/schedule', { params: { term } });
    }
};
```

åœ¨ `index.js` ä¸­æ³¨å†Œï¼š

```javascript
const api = {
    grade: gradeApi,
    schedule: scheduleApi  // æ–°å¢
};
```

### 8.2 åˆ›å»ºé¡µé¢æ¨¡æ¿

```html
<!-- web/templates/schedule.html -->
{{template "layouts/base.html" .}}
{{define "content"}}
<div class="container mx-auto p-4 max-w-lg">
    <h1 class="text-xl font-bold mb-4">è¯¾è¡¨æŸ¥è¯¢</h1>

    <!-- Cookie è¾“å…¥ -->
    <div id="app">
        <div class="bg-white rounded-lg p-4 shadow">
            <textarea
                id="cookieInput"
                class="w-full border rounded p-2 mb-3"
                rows="3"
                placeholder="è¯·ç²˜è´´ Cookie"
            ></textarea>
            <button
                onclick="handleQuery()"
                class="w-full bg-blue-500 text-white py-2 rounded"
            >
                æŸ¥è¯¢è¯¾è¡¨
            </button>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div id="result" class="mt-4"></div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script src="/static/js/api/schedule.js"></script>
<script src="/static/js/pages/schedule.js"></script>
{{end}}
```

### 8.3 åˆ›å»ºé¡µé¢é€»è¾‘

```javascript
// web/static/js/pages/schedule.js
document.addEventListener('DOMContentLoaded', function() {
    // è‡ªåŠ¨å¡«å……å·²ä¿å­˜çš„ Cookie
    document.getElementById('cookieInput').value = cookieUtils.get();
});

async function handleQuery() {
    const cookie = document.getElementById('cookieInput').value;
    if (!cookie.trim()) {
        vant.showToast('è¯·è¾“å…¥ Cookie');
        return;
    }

    // ä¿å­˜ Cookie
    cookieUtils.save(cookie);

    // æ˜¾ç¤ºåŠ è½½
    vant.showLoadingToast({ message: 'æŸ¥è¯¢ä¸­...', forbidClick: true });

    try {
        const res = await api.schedule.getSchedule();
        vant.closeToast();
        renderSchedule(res.data);
    } catch (err) {
        vant.closeToast();
    }
}

function renderSchedule(data) {
    // æ¸²æŸ“è¯¾è¡¨åˆ° #result
}
```

### 8.4 æ³¨å†Œè·¯ç”± (Go)

```go
// main.go
r.GET("/schedule", func(c *gin.Context) {
    c.HTML(http.StatusOK, "schedule.html", gin.H{
        "Title": "è¯¾è¡¨æŸ¥è¯¢",
    })
})
```

---

## 9. å‘½åè§„èŒƒ (Naming Conventions)

### 9.1 æ–‡ä»¶å‘½å

| ç±»å‹            | å‘½åè§„åˆ™            | ç¤ºä¾‹                       |
| --------------- | ------------------- | -------------------------- |
| Go æ–‡ä»¶         | å°å†™ä¸‹åˆ’çº¿          | `grade_service.go`         |
| HTML æ¨¡æ¿       | å°å†™è¿å­—ç¬¦æˆ–ä¸‹åˆ’çº¿  | `grade.html`               |
| JS API æ¨¡å—     | å°å†™               | `grade.js`                 |
| JS é¡µé¢é€»è¾‘     | å°å†™               | `grade.js` (åœ¨ pages ç›®å½•) |

### 9.2 å˜é‡å‘½å

| è¯­è¨€       | è§„åˆ™            | ç¤ºä¾‹                      |
| ---------- | --------------- | ------------------------- |
| Go         | é©¼å³°å‘½å        | `courseList`, `GetGrade`  |
| JavaScript | å°é©¼å³°          | `gradeApi`, `handleSubmit` |
| JSON å­—æ®µ  | è›‡å½¢å‘½å        | `course_name`, `created_at` |
| CSS ç±»å   | Tailwind ä¼˜å…ˆ   | `bg-blue-500`, `text-lg`  |

---

## 10. é¦–é¡µå¯¼èˆªè§„èŒƒ (Index Page)

é¦–é¡µä½œä¸ºåŠŸèƒ½å…¥å£ï¼Œéœ€æ¸…æ™°å±•ç¤ºæ‰€æœ‰å¯ç”¨åŠŸèƒ½ï¼š

```html
<!-- web/templates/index.html -->
{{template "layouts/base.html" .}}
{{define "content"}}
<div class="container mx-auto p-4 max-w-lg">
    <h1 class="text-2xl font-bold text-center mb-6">QFNU æ•™åŠ¡åŠ©æ‰‹</h1>

    <div class="grid grid-cols-2 gap-4">
        <a href="/grade" class="bg-white rounded-lg p-4 shadow text-center">
            <div class="text-3xl mb-2">ğŸ“Š</div>
            <div class="font-medium">æˆç»©æŸ¥è¯¢</div>
        </a>
        <a href="/schedule" class="bg-white rounded-lg p-4 shadow text-center">
            <div class="text-3xl mb-2">ğŸ“…</div>
            <div class="font-medium">è¯¾è¡¨æŸ¥è¯¢</div>
        </a>
        <!-- æ›´å¤šåŠŸèƒ½å¡ç‰‡ -->
    </div>
</div>
{{end}}
```

