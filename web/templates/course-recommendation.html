{{ define "title" }}选课推荐 - 曲奇API{{ end }}
{{ define "head" }}
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
{{ end }}
{{ define "body" }}
    <!-- JS 模块 -->
    <script src="/static/js/components/toast.js"></script>
    <script src="/static/js/utils/storage.js"></script>
    <script src="/static/js/api/request.js"></script>
    <script src="/static/js/api/course-recommendation.js"></script>

    <div x-data="courseRecApp()" x-cloak class="max-w-4xl mx-auto px-4 py-8">
        <!-- 标题 -->
        <header class="mb-8 text-center">
            <h1 class="text-[28px] font-bold text-[#1C1C1E] leading-tight">选课推荐系统</h1>
            <p class="text-[#8E8E93] mt-2 text-[15px]">
                <a href="/" class="hover:text-primary transition-colors">曲奇API</a>
            </p>
        </header>

        <!-- 顶部提示 -->
        <div class="bg-primary/5 border border-primary/10 rounded-2xl p-4 mb-6">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-primary mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h4 class="text-[15px] font-medium text-[#1C1C1E] mb-1">功能说明</h4>
                    <p class="text-[13px] text-[#8E8E93]">在这里你可以查看其他同学推荐的课程，也可以分享你觉得不错的课程。所有推荐信息需经管理员审核后才会公开展示。</p>
                </div>
            </div>
        </div>

        <!-- 选项卡切换 -->
        <div class="bg-[#E5E5EA] dark:bg-[#2C2C2E] rounded-xl p-0.5 flex relative mb-6">
            <div class="absolute bg-white dark:bg-[#1C1C1E] rounded-lg shadow-sm transition-all duration-[250ms] h-[calc(100%-4px)] w-1/2 top-0.5 left-0.5"
                :class="currentTab === 'query' ? 'translate-x-0' : 'translate-x-full'"></div>

            <button @click="currentTab = 'query'"
                class="flex-1 py-2 text-center text-[15px] font-medium relative z-10 transition-colors duration-200"
                :class="currentTab === 'query' ? 'text-[#1C1C1E] dark:text-white' : 'text-[#8E8E93]'">
                查推荐
            </button>
            <button @click="currentTab = 'recommend'"
                class="flex-1 py-2 text-center text-[15px] font-medium relative z-10 transition-colors duration-200"
                :class="currentTab === 'recommend' ? 'text-[#1C1C1E] dark:text-white' : 'text-[#8E8E93]'">
                我要推荐
            </button>
        </div>

        <!-- 查询模块 -->
        <div x-show="currentTab === 'query'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">
            <!-- 搜索框 -->
            <div class="card mb-6">
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="relative flex-1">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[#8E8E93]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" x-model="keyword"
                            @keyup.enter="search()"
                            class="input-field pl-10"
                            placeholder="搜索课程名称或教师姓名...">
                    </div>
                    <button @click="search()" :disabled="loading" class="btn-primary flex items-center justify-center min-w-[100px] shadow-md">
                        <template x-if="loading">
                            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-show="!loading">搜索</span>
                    </button>
                </div>
            </div>

            <!-- 搜索结果统计 -->
            <div x-show="results.length > 0" class="mb-4 flex items-center text-[13px] text-[#8E8E93] px-2">
                <span>共找到 <span x-text="results.length"></span> 条相关推荐</span>
            </div>

            <!-- 结果列表 -->
            <div class="space-y-4">
                <template x-for="item in results" :key="item.recommendation_time">
                    <div class="card hover:shadow-md transition-shadow duration-200">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-[17px] font-semibold text-[#1C1C1E] mb-1" x-html="highlight(item.course_name)"></h3>
                                <div class="flex items-center text-[13px] text-[#8E8E93]">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <span x-html="highlight(item.teacher_name)"></span>
                                </div>
                            </div>
                            <span class="text-[11px] text-[#8E8E93] bg-[#F2F2F7] px-2 py-1 rounded-lg" x-text="formatTime(item.recommendation_time)"></span>
                        </div>

                        <div class="bg-[#F2F2F7] dark:bg-[#2C2C2E] rounded-xl p-3 mb-3">
                            <p class="text-[15px] text-[#1C1C1E] dark:text-white leading-relaxed whitespace-pre-wrap" x-text="item.recommendation_reason"></p>
                        </div>

                        <div class="flex justify-end items-center">
                            <span class="text-[12px] text-[#8E8E93]">推荐人：<span x-text="item.recommender_nickname"></span></span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- 空状态 -->
            <div x-show="hasSearched && results.length === 0" class="py-16 text-center">
                <svg class="w-20 h-20 mx-auto text-[#C7C7CC] mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-[#8E8E93]">没有找到相关推荐记录</p>
            </div>

            <div x-show="!hasSearched" class="py-16 text-center">
                <svg class="w-20 h-20 mx-auto text-[#C7C7CC] mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <p class="text-[#8E8E93]">输入关键词开始搜索课程推荐</p>
            </div>
        </div>

        <!-- 推荐模块 -->
        <div x-show="currentTab === 'recommend'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">
            <div class="card">
                <div class="space-y-5">
                    <!-- 课程名称 -->
                    <div>
                        <label class="block text-[15px] font-medium text-[#1C1C1E] mb-2">课程名称 <span class="text-danger">*</span></label>
                        <input type="text" x-model="form.course_name" class="input-field" placeholder="例如：高等数学">
                    </div>

                    <!-- 教师姓名 -->
                    <div>
                        <label class="block text-[15px] font-medium text-[#1C1C1E] mb-2">教师姓名 <span class="text-danger">*</span></label>
                        <input type="text" x-model="form.teacher_name" class="input-field" placeholder="例如：张三">
                    </div>

                    <!-- 推荐人昵称 -->
                    <div>
                        <label class="block text-[15px] font-medium text-[#1C1C1E] mb-2">你的昵称 <span class="text-danger">*</span></label>
                        <input type="text" x-model="form.recommender_nickname" class="input-field" placeholder="可以是化名">
                    </div>

                    <!-- 推荐理由 -->
                    <div>
                        <label class="block text-[15px] font-medium text-[#1C1C1E] mb-2">推荐理由 <span class="text-danger">*</span></label>
                        <textarea x-model="form.recommendation_reason" rows="4" class="input-field resize-none py-3" placeholder="请详细描述该课程的优点、老师的授课风格、考核方式等..."></textarea>
                        <p class="text-[12px] text-[#8E8E93] mt-1 text-right" :class="form.recommendation_reason.length > 500 ? 'text-danger' : ''">
                            <span x-text="form.recommendation_reason.length"></span>/500
                        </p>
                    </div>

                    <!-- 提交按钮 -->
                    <button @click="submitRecommendation()" :disabled="submitting" class="btn-primary w-full py-3.5 text-[16px] shadow-lg hover:shadow-xl transition-shadow active:scale-[0.98] transform duration-150">
                        <template x-if="submitting">
                            <div class="flex items-center justify-center">
                                <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span>提交中...</span>
                            </div>
                        </template>
                        <span x-show="!submitting">提交推荐</span>
                    </button>

                    <p class="text-center text-[13px] text-[#8E8E93] mt-4">提交后需等待管理员审核通过后才会显示</p>
                </div>
            </div>
        </div>
    </div>
{{ end }}
{{ define "scripts" }}
    <script>
        function courseRecApp() {
            return {
                currentTab: 'query',
                keyword: '',
                lastKeyword: '',
                results: [],
                loading: false,
                hasSearched: false,

                // 表单数据
                form: {
                    course_name: '',
                    teacher_name: '',
                    recommender_nickname: '',
                    recommendation_reason: ''
                },
                submitting: false,

                // 搜索方法
                async search() {
                    if (!this.keyword.trim()) {
                        vant.showToast('请输入搜索关键词');
                        return;
                    }

                    this.loading = true;
                    this.lastKeyword = this.keyword;
                    try {
                        const res = await window.CourseRecommendationApi.query(this.keyword);
                        this.results = res.data || [];
                        this.hasSearched = true;

                        if (this.results.length === 0) {
                            vant.showToast('未找到相关记录');
                        }
                    } catch (error) {
                        console.error(error);
                        vant.showToast(error.message || '查询失败');
                    } finally {
                        this.loading = false;
                    }
                },

                // 提交方法
                async submitRecommendation() {
                    // 验证
                    if (!this.form.course_name.trim()) return vant.showToast('请输入课程名称');
                    if (!this.form.teacher_name.trim()) return vant.showToast('请输入教师姓名');
                    if (!this.form.recommender_nickname.trim()) return vant.showToast('请输入您的昵称');
                    if (!this.form.recommendation_reason.trim()) return vant.showToast('请输入推荐理由');
                    if (this.form.recommendation_reason.length > 500) return vant.showToast('推荐理由字数过多');

                    this.submitting = true;
                    try {
                        await window.CourseRecommendationApi.recommend(this.form);
                        vant.showToast({
                            type: 'success',
                            message: '提交成功，等待审核',
                            duration: 2000
                        });

                        // 清空表单
                        this.form = {
                            course_name: '',
                            teacher_name: '',
                            recommender_nickname: '',
                            recommendation_reason: ''
                        };

                        // 2秒后切换回查询页
                        setTimeout(() => {
                            this.currentTab = 'query';
                        }, 2000);

                    } catch (error) {
                        vant.showToast(error.message || '提交失败');
                    } finally {
                        this.submitting = false;
                    }
                },

                // 工具方法
                formatTime(ts) {
                    return window.CourseRecommendationApi.formatTime(ts);
                },

                highlight(text) {
                    return window.CourseRecommendationApi.highlightKeyword(text, this.lastKeyword);
                }
            }
        }
    </script>
{{ end }}
